@rendermode InteractiveServer
@using ENOC.Dashboard.Models
@inject LookupApiService LookupApi

<div class="teams-message">
    <div class="teams-section">
        <h3 class="header-font">Team</h3>
        <div class="teams">
            <div class="rect-img rect-img-custom" style="background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, #000000 100%), url('/incident-steps-images/team-management.png');">
                <span class="rect-img-font">Management</span>
            </div>
            <div class="rect-img rect-img-custom" style="background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, #000000 100%), url('/incident-steps-images/team-eerc.png');">
                <span class="rect-img-font">EERC</span>
            </div>
        </div>
    </div>
    <div class="teams-section" style="flex-shrink: 2;">
        <h3 class="header-font">Message</h3>
        <div class="messages search-box" style="max-width: 100%;">
            <select class="form-select" @bind="selectedMessageId" @bind:after="OnMessageSelected">
                <option value="">Select a message</option>
                @foreach (var message in Messages)
                {
                    <option value="@message.Id">@message.Description</option>
                }
            </select>
        </div>
        <div style="display: flex; width: 100%; justify-content: end;">
            <button class="btn custom-button" @onclick="OpenCustomMessageModal" style="width: 100%;">
                <span class="rounded-blue-button-font">Custom message</span>
            </button>
        </div>
    </div>
</div>

@if (showCustomMessageModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" style="max-width: 660px;">
            <div class="modal-content" style="gap: 24px;">
                <div class="modal-header" style="align-items: center; padding: 0;">
                    <h5 class="modal-title">Custom Message</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseCustomMessageModal"></button>
                </div>
                <div class="modal-body search-box" style="padding: 0; max-width: 100%;">
                    <textarea class="form-control" @bind="customMessageText" rows="9" placeholder="Enter your custom message here..."></textarea>
                </div>
                <div class="modal-footer" style="justify-content: center; padding: 0;">
                    <button type="button" class="btn custom-button" @onclick="AddCustomMessage">
                        <span class="rounded-blue-button-font">Add</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showConfirm == true)
{
    <button type="button"
            id="form-button"
            class="btn btn-secondary btn-aqua rect-button-confirm incident-form-button mt-2"
            @onclick="HandleConfirm"
            disabled="@(!CanConfirm)">
        Confirm
    </button>
}

@code {
    [Parameter]
    public Func<Task> onConfirm { get; set; }

    [Parameter]
    public bool? showConfirm { get; set; }

    [Parameter]
    public IncidentFormState? FormState { get; set; }

    private List<MessageModel> Messages = new();
    private Guid? selectedMessageId;
    private string selectedMessage = string.Empty;
    private bool showCustomMessageModal = false;
    private string customMessageText = string.Empty;

    private bool CanConfirm => selectedMessageId.HasValue || !string.IsNullOrEmpty(customMessageText);

    protected override async Task OnInitializedAsync()
    {
        await LoadMessagesAsync();

        // Load previous selections if any
        if (FormState != null)
        {
            selectedMessageId = FormState.MessageId;
            customMessageText = FormState.CustomMessage ?? string.Empty;
        }
    }

    protected override void OnParametersSet()
    {
        if (showConfirm == null)
        {
            showConfirm = true;
        }
    }

    private async Task LoadMessagesAsync()
    {
        var messages = await LookupApi.GetMessagesAsync();
        if (messages != null)
        {
            Messages = messages.Select(m => new MessageModel
            {
                Id = m.Id,
                Description = m.Description
            }).ToList();
        }
    }

    public class MessageModel
    {
        public Guid Id { get; set; }
        public string Description { get; set; } = string.Empty;
    }

    private void OpenCustomMessageModal()
    {
        showCustomMessageModal = true;
        customMessageText = string.Empty;
    }

    private void CloseCustomMessageModal()
    {
        showCustomMessageModal = false;
        customMessageText = string.Empty;
    }

    private void AddCustomMessage()
    {
        if (!string.IsNullOrWhiteSpace(customMessageText))
        {
            selectedMessageId = null; // Clear selected message when using custom
            if (FormState != null)
            {
                FormState.CustomMessage = customMessageText;
                FormState.MessageId = null;
            }
            CloseCustomMessageModal();
        }
    }

    private void OnMessageSelected()
    {
        if (selectedMessageId.HasValue && FormState != null)
        {
            var message = Messages.FirstOrDefault(m => m.Id == selectedMessageId.Value);
            FormState.MessageId = selectedMessageId.Value;
            FormState.MessageText = message?.Description;
            FormState.CustomMessage = null; // Clear custom message
            customMessageText = string.Empty;
        }
    }

    private async Task HandleConfirm()
    {
        if (CanConfirm && onConfirm != null)
        {
            await onConfirm();
        }
    }
}